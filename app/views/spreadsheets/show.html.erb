<div class="spreadsheet-editor" data-controller="spreadsheet">
  <!-- Header -->
  <div class="editor-header">
    <div class="editor-title">
      <h1><%= @spreadsheet.name %></h1>
      <%= link_to "Редактировать", edit_spreadsheet_path(@spreadsheet), class: "btn btn-sm" %>
      <%= link_to "← К списку таблиц", spreadsheets_path, class: "btn btn-sm" %>
    </div>

    <div class="editor-actions">
      <button class="btn btn-sm" onclick="addRow()">+ Добавить строку</button>
      <button class="btn btn-sm" onclick="addColumn()">+ Добавить колонку</button>
    </div>
  </div>

  <!-- Sheet tabs -->
  <div class="sheet-tabs">
    <% @spreadsheet.sheets.each do |sheet| %>
      <div class="sheet-tab <%= 'active' if sheet.id == @current_sheet.id %>">
        <%= link_to sheet.name, spreadsheet_path(@spreadsheet, sheet_id: sheet.id) %>
      </div>
    <% end %>
    <button class="sheet-tab new-sheet" onclick="addSheet()">+ Новый лист</button>
  </div>

  <!-- Spreadsheet grid -->
  <div class="grid-container">
    <div class="grid-wrapper">
      <table class="spreadsheet-grid" id="spreadsheet-grid">
        <thead>
          <tr>
            <th class="row-header">#</th>
            <% @current_sheet.column_definitions.each do |col| %>
              <th class="column-header" data-column="<%= col['key'] || col[:key] %>">
                <span class="column-name"><%= col['name'] || col[:name] %></span>
                <span class="column-type">(<%= col['type'] || col[:type] %>)</span>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @current_sheet.rows.each do |row| %>
            <tr data-row-id="<%= row.id %>" data-position="<%= row.position %>">
              <td class="row-number"><%= row.position %></td>
              <% @current_sheet.column_definitions.each do |col| %>
                <% column_key = col['key'] || col[:key] %>
                <% cell = row.cells.find { |c| c.column_key == column_key } %>
                <td class="cell"
                    data-row="<%= row.id %>"
                    data-column="<%= column_key %>"
                    data-type="<%= col['type'] || col[:type] %>"
                    contenteditable="true"
                    data-formula="<%= cell&.formula %>"
                    data-value="<%= cell&.value %>">
                  <%= cell&.computed_value || cell&.value %>
                </td>
              <% end %>
            </tr>
          <% end %>

          <!-- Empty rows for better UX -->
          <% if @current_sheet.rows.empty? %>
            <% 10.times do |i| %>
              <tr class="empty-row" data-position="<%= i + 1 %>">
                <td class="row-number"><%= i + 1 %></td>
                <% @current_sheet.column_definitions.each do |col| %>
                  <td class="cell empty"
                      data-column="<%= col['key'] || col[:key] %>"
                      data-type="<%= col['type'] || col[:type] %>"
                      contenteditable="true"></td>
                <% end %>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Formula bar -->
  <div class="formula-bar" id="formula-bar">
    <label>Формула:</label>
    <input type="text" id="formula-input" placeholder="Введите формулу (например: =SUM(A1:A10))" />
    <button class="btn btn-sm" onclick="applyFormula()">Применить</button>
  </div>
</div>

<script>
  let currentCell = null;
  const spreadsheetId = <%= @spreadsheet.id %>;
  const sheetId = <%= @current_sheet.id %>;

  // Handle cell selection
  document.querySelectorAll('.cell').forEach(cell => {
    cell.addEventListener('focus', function() {
      currentCell = this;
      const formula = this.dataset.formula;
      if (formula) {
        document.getElementById('formula-input').value = '=' + formula;
      } else {
        document.getElementById('formula-input').value = '';
      }
      this.classList.add('selected');
    });

    cell.addEventListener('blur', function() {
      this.classList.remove('selected');
      saveCell(this);
    });

    cell.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        moveToNextRow(this);
      } else if (e.key === 'Tab') {
        e.preventDefault();
        moveToNextCell(this);
      }
    });
  });

  function saveCell(cellElement) {
    const rowId = cellElement.dataset.row;
    const columnKey = cellElement.dataset.column;
    const value = cellElement.textContent.trim();
    const formula = cellElement.dataset.formula || '';

    // Skip if empty row (no row ID yet)
    if (!rowId) {
      if (value) {
        createRowWithValue(cellElement, columnKey, value);
      }
      return;
    }

    // Send update to server
    fetch(`/spreadsheets/${spreadsheetId}/sheets/${sheetId}/rows/${rowId}/cells/${columnKey}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        value: value,
        formula: formula,
        data_type: cellElement.dataset.type
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        cellElement.dataset.value = data.cell.value;
        if (data.cell.formula) {
          cellElement.dataset.formula = data.cell.formula;
        }
        console.log('Cell saved successfully');
      }
    })
    .catch(error => console.error('Error saving cell:', error));
  }

  function createRowWithValue(cellElement, columnKey, value) {
    const row = cellElement.closest('tr');
    const position = row.dataset.position;

    fetch(`/spreadsheets/${spreadsheetId}/sheets/${sheetId}/rows`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        data: {},
        cells: {
          [columnKey]: {
            value: value,
            data_type: cellElement.dataset.type
          }
        }
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        row.dataset.rowId = data.row.id;
        row.classList.remove('empty-row');
        // Update all cells in this row with the correct row ID
        row.querySelectorAll('.cell').forEach(cell => {
          cell.dataset.row = data.row.id;
        });
        console.log('Row created successfully');
      }
    })
    .catch(error => console.error('Error creating row:', error));
  }

  function moveToNextCell(currentCell) {
    const cell = currentCell.nextElementSibling;
    if (cell && cell.classList.contains('cell')) {
      cell.focus();
    }
  }

  function moveToNextRow(currentCell) {
    const currentRow = currentCell.closest('tr');
    const nextRow = currentRow.nextElementSibling;
    if (nextRow) {
      const columnIndex = Array.from(currentRow.children).indexOf(currentCell);
      const nextCell = nextRow.children[columnIndex];
      if (nextCell && nextCell.classList.contains('cell')) {
        nextCell.focus();
      }
    }
  }

  function applyFormula() {
    if (!currentCell) {
      alert('Выберите ячейку');
      return;
    }

    const formulaInput = document.getElementById('formula-input');
    let formula = formulaInput.value.trim();

    if (formula.startsWith('=')) {
      formula = formula.substring(1);
    }

    currentCell.dataset.formula = formula;
    currentCell.textContent = '=' + formula;
    saveCell(currentCell);
  }

  function addRow() {
    fetch(`/spreadsheets/${spreadsheetId}/sheets/${sheetId}/rows`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ data: {} })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(error => console.error('Error adding row:', error));
  }

  function addColumn() {
    const name = prompt('Название колонки:');
    if (!name) return;

    const type = prompt('Тип данных (text, number, date):', 'text');

    fetch(`/spreadsheets/${spreadsheetId}/sheets/${sheetId}/add_column`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ name: name, type: type || 'text' })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(error => console.error('Error adding column:', error));
  }

  function addSheet() {
    const name = prompt('Название листа:');
    if (!name) return;

    fetch(`/spreadsheets/${spreadsheetId}/sheets`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ sheet: { name: name } })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id) {
        location.reload();
      }
    })
    .catch(error => console.error('Error adding sheet:', error));
  }
</script>

<style>
  * {
    box-sizing: border-box;
  }

  .spreadsheet-editor {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #f8f9fa;
  }

  .editor-header {
    background: white;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .editor-title {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .editor-title h1 {
    margin: 0;
    font-size: 1.5rem;
    color: #2c3e50;
  }

  .editor-actions {
    display: flex;
    gap: 10px;
  }

  .sheet-tabs {
    background: white;
    display: flex;
    border-bottom: 2px solid #dee2e6;
    padding: 0 20px;
  }

  .sheet-tab {
    padding: 10px 20px;
    cursor: pointer;
    border: none;
    background: none;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
  }

  .sheet-tab:hover {
    background: #f8f9fa;
  }

  .sheet-tab.active {
    color: #667eea;
    border-bottom-color: #667eea;
    font-weight: 600;
  }

  .sheet-tab a {
    text-decoration: none;
    color: inherit;
  }

  .sheet-tab.new-sheet {
    color: #999;
    font-weight: normal;
  }

  .grid-container {
    flex: 1;
    overflow: auto;
    padding: 20px;
  }

  .grid-wrapper {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: auto;
  }

  .spreadsheet-grid {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
  }

  .spreadsheet-grid th,
  .spreadsheet-grid td {
    border: 1px solid #dee2e6;
    padding: 8px 12px;
    min-width: 120px;
  }

  .spreadsheet-grid th {
    background: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .row-header,
  .row-number {
    background: #f8f9fa;
    text-align: center;
    font-weight: 600;
    min-width: 50px;
    max-width: 50px;
    color: #666;
    user-select: none;
  }

  .column-header {
    text-align: left;
    user-select: none;
  }

  .column-name {
    font-weight: 600;
    color: #2c3e50;
  }

  .column-type {
    font-size: 0.85em;
    color: #999;
    font-weight: normal;
  }

  .cell {
    background: white;
    cursor: text;
    transition: all 0.1s ease;
  }

  .cell:hover {
    background: #f0f4ff;
  }

  .cell:focus {
    outline: 2px solid #667eea;
    background: white;
    z-index: 5;
  }

  .cell.selected {
    outline: 2px solid #667eea;
    background: #f0f4ff;
  }

  .cell.empty {
    background: #fafafa;
  }

  .empty-row {
    opacity: 0.6;
  }

  .formula-bar {
    background: white;
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .formula-bar label {
    font-weight: 600;
    color: #2c3e50;
  }

  .formula-bar input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
  }

  .formula-bar input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .btn {
    padding: 8px 16px;
    font-size: 0.9rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s ease;
    background: #667eea;
    color: white;
  }

  .btn:hover {
    background: #5568d3;
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 0.85rem;
  }
</style>
